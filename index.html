<!DOCTYPE html>
<html>

<head>
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type" />
    <meta content="en-us" http-equiv="Content-Language" />
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    <title>Heizungsanlage Monitor</title>
</head>

<body onload="init();">
    <h1>Heizungsanlage Monitor (V1.0)</h1>
    <canvas id="canv1" width="640" height="320" style="border:1px solid #68471d; background-color:#ccdbdd">
    </canvas>

    <script type="text/javascript">

        // Temperatures
        var temp_kamin   = 0; //"--";
        var temp_puffer1 = 0; //"--";
        var temp_puffer2 = 0; //"--";
        var temp_puffer3 = 0; //"--";

        // Positions
        const kamin_x = 40;
        const kamin_y = 180;
        const kamin_w = 60;
        const kamin_h = 100;
        const puffer_x = 240;
        const puffer_y = 120;
        const puffer_w = 80;
        const puffer_h = 160;
        const brenner_x = 460;
        const brenner_y = 180;
        const brenner_w = 80;
        const brenner_h = 100;
        const heizung_x = 460;
        const heizung_y = 40;
        const heizung_w = 80;
        const heizung_h = 50;

        var line_offset = 0;

        function draw() {
            var canvas = document.getElementById('canv1');
            if (canvas.getContext) {
                var ctx = canvas.getContext('2d');
            } else {
                return;
            }

            function draw_text() {
                ctx.font = "24px Arial";
                ctx.fillStyle = "#000000";
                ctx.fillText("Kamin", kamin_x, kamin_y - 5);
                ctx.fillText("Puffer", puffer_x, puffer_y - 5);
                ctx.fillText("Brenner", brenner_x, brenner_y - 5);

                ctx.fillText(temp_kamin, kamin_x + kamin_w + 10, kamin_y + 10);
                ctx.fillText(temp_puffer1, puffer_x - 28, puffer_y + 20);
                ctx.fillText(temp_puffer2, puffer_x - 28, puffer_y + 70);
                ctx.fillText(temp_puffer3, puffer_x - 28, puffer_y + 130);
            }

            function draw_kamin() {
                // Kamin
                ctx.fillStyle = "#68471d";
                ctx.fillRect(kamin_x, kamin_y, kamin_w, kamin_h);
                ctx.clearRect(kamin_x + 10, kamin_y + 25, kamin_w - 20, kamin_h - 60);
            }

            // calculate a color value between red and blue according to the temperature parameter
            function calc_tcolor( temp ) {
                var tmax = 80; // everything above tmax is 100% red, 0% blue
                var tmin = 20; // everything below tmin is 0% red, 100% blue
                var red = (temp - tmin) * 256 / (tmax - tmin);
                if (red >= 256) red = 255;
                var blue = 255 - red;
                var color = "rgb(" + red + ",0," + blue + ", 255)";
                return color;
            }

            function draw_puffer() {
                // Puffer mit Temperaturanimation
                // Create gradient
                var grd = ctx.createLinearGradient(0, puffer_y, 0, puffer_y+puffer_h);
                var color1 = calc_tcolor(temp_puffer1);
                var color2 = calc_tcolor(temp_puffer2);
                var color3 = calc_tcolor(temp_puffer3);
                grd.addColorStop(0, color1);
                grd.addColorStop(0.5, color2);
                grd.addColorStop(1, color3);
                // Fill with gradient
                ctx.fillStyle = grd;
                ctx.fillRect(puffer_x, puffer_y, puffer_w, puffer_h);
            }

            function draw_kessel() {
                // Ã–l-Brenner
                ctx.fillStyle = "#aa0000";
                ctx.beginPath();
                ctx.moveTo(brenner_x, brenner_y);
                ctx.lineTo(brenner_x + brenner_w - 30, brenner_y);
                ctx.lineTo(brenner_x + brenner_w, brenner_y + 30);
                ctx.lineTo(brenner_x + brenner_w, brenner_y + brenner_h);
                ctx.lineTo(brenner_x,             brenner_y + brenner_h);
                ctx.closePath();
                ctx.fill();
            }

            function draw_heizung() {
                // Heizung
                ctx.strokeStyle = "#eeeeee";
                ctx.lineCap = "round";
                ctx.lineWidth = 20;
                ctx.lineDashOffset = 0;
                ctx.setLineDash([]);
                ctx.beginPath();
                ctx.moveTo(heizung_x, heizung_y);
                ctx.lineTo(heizung_x, heizung_y + heizung_h);
                ctx.moveTo(heizung_x+22, heizung_y);
                ctx.lineTo(heizung_x+22, heizung_y + heizung_h);
                ctx.moveTo(heizung_x+44, heizung_y);
                ctx.lineTo(heizung_x+44, heizung_y + heizung_h);
                ctx.moveTo(heizung_x+66, heizung_y);
                ctx.lineTo(heizung_x+66, heizung_y + heizung_h);
                ctx.stroke();
            }

            function leitung_kamin_puffer() {
                // Leitung Kamin - Puffer
                ctx.strokeStyle = "#ff0000";
                ctx.lineCap = "butt";
                ctx.lineWidth = 6;
                ctx.lineJoin = "round";
                ctx.lineDashOffset = -line_offset;
                ctx.setLineDash([15,5]);
                ctx.beginPath();
                ctx.moveTo(kamin_x + kamin_w, kamin_y + 20);
                ctx.lineTo(puffer_x - 50,     kamin_y + 20);
                ctx.lineTo(puffer_x - 50,     puffer_y + 25);
                ctx.lineTo(puffer_x,          puffer_y + 25);
                ctx.stroke();

                ctx.strokeStyle = "#0000ff";
                ctx.lineDashOffset = line_offset;
                ctx.beginPath();
                ctx.moveTo(kamin_x + kamin_w,  kamin_y + kamin_h -20 );
                ctx.lineTo(puffer_x,           kamin_y + kamin_h - 20);
                ctx.stroke();
            }

            function leitung_kessel_heizung() {
                // Leitung Kessel - Heizung
                ctx.strokeStyle = "#ff0000";
                ctx.lineCap = "butt";
                ctx.lineWidth = 6;
                ctx.lineJoin = "round";
                ctx.lineDashOffset = -line_offset;
                ctx.setLineDash([15,5]);
                ctx.beginPath();
                ctx.moveTo(brenner_x,         brenner_y + 20);
                ctx.lineTo(brenner_x - 50,    brenner_y + 20);
                ctx.lineTo(brenner_x - 50,    heizung_y + 10);
                ctx.lineTo(heizung_x,         heizung_y + 10);
                ctx.stroke();

                ctx.strokeStyle = "#0000ff";
                ctx.lineDashOffset = line_offset;
                ctx.beginPath();
                ctx.moveTo(brenner_x,         brenner_y + 80);
                ctx.lineTo(brenner_x - 70,    brenner_y + 80);
                ctx.lineTo(brenner_x - 70,    heizung_y + heizung_h + 25);
                ctx.lineTo(heizung_x + heizung_w - 15, heizung_y + heizung_h + 25);
                ctx.lineTo(heizung_x + heizung_w - 15, heizung_y + heizung_h);
                ctx.stroke();
            }

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            leitung_kamin_puffer();
            leitung_kessel_heizung();
            draw_kamin();
            draw_puffer();
            draw_kessel();
            draw_heizung();
            draw_text();

            if (temp_kamin > 55)
            {
                if (++line_offset > 19) line_offset = 0;
            }
            else {
                line_offset = 0;
            }
            setTimeout(draw, 80);  // redraw for animation every 100 ms
        }

        function refresh() {
            var req = new XMLHttpRequest();
            console.log("Grabbing Value");
            req.onreadystatechange = function() {
                if (req.readyState == 4 && req.status == 200) {
                    document.getElementById('temperatur1').innerText = req.responseText;
                    //temp_kamin = req.responseText;
                    var arr = req.responseText.split(",");
                    if (arr.length >= 4) {
                        temp_kamin   = parseInt(arr[0], 10);
                        temp_puffer1 = parseInt(arr[1], 10);
                        temp_puffer2 = parseInt(arr[2], 10);
                        temp_puffer3 = parseInt(arr[3], 10);
                    }
                }
            }
            req.open("GET", 'reload.txt', true); // Grabs whatever you've written in this file
            req.send(null);
        }

        function init() // function the browser first runs when it's loaded.
        {
            draw();
            refresh();   // Run the refresh function for the first time.
            setInterval(refresh, 10000);  // interval to reload values in ms.
        }
    </script>

    <div id="main">
        <div id="updateMe">
            <h2>reload.txt:</h2>
            <h1 id="temperatur1"></h1>
        </div>
    </div>
</body>

</html>
